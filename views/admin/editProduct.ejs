<%- include('../admin/layout/adminHeader.ejs') -%>

  <style>
    .error {
      color: red;
    }
  </style>

  <div class="col-12 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Edit Product</h4>
        <br>
        <form action="/admin/edit-Pro?id=<%= currentData._id %>" method="post" enctype="multipart/form-data">
          <div class="form-group">
            <label for="exampleInputName1">Name Of Product</label>
            <input type="text" class="form-control" id="name" placeholder="Name" name="proName"
              value="<%= currentData.productname %>">
          </div>
          <input type="hidden" name="product_id" value="<%= currentData._id %>">
          <div class="form-group">
            <label for="exampleInputEmail3">Quantity</label>
            <input type="text" class="form-control" id="exampleInputEmail3" placeholder="Quantity" name="qty"
              value="<%= currentData.quantity %>">
          </div>
          <div class="form-group">
            <label for="price">Price</label>
            <div class="input-group" id="price">
              <div class="input-group-prepend">
                <span class="input-group-text">â‚¹</span>
              </div>
              <input type="text" class="form-control" aria-label="Amount (to the nearest dollar)" name="price"
                value="<%= currentData.price %>">
            </div>
          </div>
          <div class="form-group">
            <label for="exampleSelectGender">Category</label>
            <select class="form-control" id="exampleSelectGender" name="category" required>
              <% catData.forEach((item)=> { %>
                <% if (item.blocked==0) { %>
                  <option value="<%= item.name %>" <% if (item.name===currentData.category) { %>selected<% } %>>
                      <%= item.name %>
                  </option>
                  <% } %>
                    <% }); %>
            </select>
          </div>
          <div class="form-group">
            <label for="ccbox">Size</label>
            <div class="form-check" id="ccbox">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="S" id="checkbox1" name="options" <% if
                  (currentData.size.includes('S')) { %>checked<% } %>>
                  <label class="form-check-label" for="checkbox1">
                    S
                  </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="M" id="checkbox2" name="options" <% if
                  (currentData.size.includes('M')) { %>checked<% } %>>
                  <label class="form-check-label" for="checkbox2">
                    M
                  </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="L" id="checkbox3" name="options" <% if
                  (currentData.size.includes('L')) { %>checked<% } %>>
                  <label class="form-check-label" for="checkbox3">
                    L
                  </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="XL" id="checkbox4" name="options" <% if
                  (currentData.size.includes('XL')) { %>checked<% } %>>
                  <label class="form-check-label" for="checkbox4">
                    XL
                  </label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="exampleTextarea1">Description</label>
            <textarea class="form-control" id="exampleTextarea1" rows="4"
              name="description"><%= currentData.description %></textarea>
          </div>
          <div class="form-group">
            <label for="exampleTextarea1">Additional Details</label>
            <textarea class="form-control" id="exampleTextarea1" rows="4"
              name="additionalInfo"><%= currentData.additionalInfo %></textarea>
          </div>
          <div id="existingImagePreview">
            <p>Existing Images:</p>
            <div id="existingImages" class="d-flex flex-nowrap overflow-auto">
              <% for(let i=0; i<image.length; i++){ %>
                <div class="existing-image-container d-inline-block mr-2">
                  <img src="/products/images/upload/<%= image[i] %>" alt="Existing Image" style="max-width: 200px;">
                  <button type="button" onclick="deleteImage('<%= currentData._id %>', '<%= image[i] %>')"
                    class="btn btn-sm btn-danger">Delete</button>
                </div>
                <% } %>
            </div>
          </div>

         
          <input type="file" class="form-control-file" name="newImage" id="newImage" accept="image/*">
          <button type="submit" class="btn btn-primary mr-2">Submit</button>
          <a href="/admin/productmanagement" class="btn btn-dark">Cancel</a>
        </form>

      </div>

    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script>
 function deleteImage(productId, deletedImage) {
  // Get the new image input
  var newImageInput = document.getElementById('newImage');
  var newImage = newImageInput.files.length > 0 ? newImageInput.files[0] : null;

  fetch('/admin/delete-image', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      productId: productId,
      deletedImage: deletedImage,
      newImage: newImage,
    }),
  })
    .then(response => response.json())
    .then(data => {
      console.log('Image deleted successfully:', data);

          // Remove the deleted image from the UI
          var existingImagesContainer = document.getElementById('existingImages');
          var deletedImageElement = Array.from(existingImagesContainer.children).find(element =>
            element.querySelector('img').src.endsWith(image)
          );
          if (deletedImageElement) {
            existingImagesContainer.removeChild(deletedImageElement);
          }

          if (data.newImage) {
        var existingImagesContainer = document.getElementById('existingImages');
        var newImageContainer = document.createElement('div');
        newImageContainer.className = 'existing-image-container d-inline-block mr-2';

        var newImage = document.createElement('img');
        newImage.src = '/products/images/upload/' + data.newImage;
        newImage.alt = 'Newly Added Image';
        newImage.style.maxWidth = '200px';

        var deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'btn btn-sm btn-danger';
        deleteButton.textContent = 'Delete';
        deleteButton.onclick = function () {
          deleteImage(productId, data.newImage);
        };

        newImageContainer.appendChild(newImage);
        newImageContainer.appendChild(deleteButton);
        existingImagesContainer.appendChild(newImageContainer);
      }
    })
    .catch(error => {
      console.error('Error deleting image:', error);
    });
}
  </script>
  <script>
    $(document).ready(function () {
      // Function to update the submit button based on validations and show error messages
      function updateSubmitButton() {
        var submitButton = $('button[type="submit"]');
        var proName = $('#name').val();
        var qty = $('#exampleInputEmail3').val();
        var price = $('#price input').val();
        var description = $('#exampleTextarea1').val();
        var additionalInfo = $('textarea[name="additionalInfo"]').val();
        var errorMessages = $('#errorMessages');

        // Validate conditions
        var isProNameValid = proName.length > 0 && proName.length <= 20;
        var isQtyValid = !isNaN(qty) && qty >= 0;
        var isPriceValid = !isNaN(price) && price >= 0;
        var isDescriptionValid = description.length >= 10;
        var isAdditionalInfoValid = additionalInfo.length >= 10;

        // Show or hide error messages
        errorMessages.empty();
        if (!isProNameValid) {
          errorMessages.append('<span class="error" id="e1">Name must be between 1 and 20 characters.</span><br>');
        }
        if (!isQtyValid) {
          errorMessages.append('<span class="error" id="e2">Quantity must be a non-negative number.</span><br>');
        }
        if (!isPriceValid) {
          errorMessages.append('<span class="error" id="e3">Price must be a non-negative number.</span><br>');
        }
        if (!isDescriptionValid) {
          errorMessages.append('<span class="error" id="e4">Description must be at least 10 characters.</span><br>');
        }
        if (!isAdditionalInfoValid) {
          errorMessages.append('<span class="error" id="e5">Additional Details must be at least 10 characters.</span><br>');
        }

        // Enable or disable the submit button
        submitButton.prop(
          'disabled',
          !(isProNameValid && isQtyValid && isPriceValid && isDescriptionValid && isAdditionalInfoValid)
        );
      }

      // Attach event listeners to form inputs
      $('#name, #exampleInputEmail3, #price input, #exampleTextarea1, textarea[name="additionalInfo"]').on(
        'input',
        function () {
          updateSubmitButton();
        }
      );

      // Initial validation on page load
      updateSubmitButton();
    });
  </script>
  <script>


    function previewExistingImages(images, productId) {
      var existingImagesContainer = document.getElementById('existingImages');
      existingImagesContainer.innerHTML = '';

      images.slice(0, 4).forEach(function (image) {
        var imageContainer = document.createElement('div');
        imageContainer.className = 'existing-image-container d-inline-block mr-2';

        var img = document.createElement('img');
        img.src = '/products/' + image;
        img.alt = 'Existing Image';
        img.style.maxWidth = '200px';

        var deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'btn btn-sm btn-danger';
        deleteButton.textContent = 'Delete';
        deleteButton.onclick = function () {
          deleteImage(productId, image);
        };

        imageContainer.appendChild(img);
        imageContainer.appendChild(deleteButton);
        existingImagesContainer.appendChild(imageContainer);
      });
    }


    previewExistingImages(<% - JSON.stringify(image) %>, '<%= currentData._id %>');

  </script>
  
  <%- include('../admin/layout/adminFooter.ejs') -%>